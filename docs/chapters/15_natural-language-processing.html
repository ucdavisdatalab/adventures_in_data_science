<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>15&nbsp; Natural Language Processing – Adventures in Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../chapters/16_geospatial-data.html" rel="next">
<link href="../chapters/14_network-analysis.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/11_optical-character-recognition.html">Special Topics</a></li><li class="breadcrumb-item"><a href="../chapters/15_natural-language-processing.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Natural Language Processing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="https://datalab.ucdavis.edu/" class="sidebar-logo-link">
      <img src="../images/datalab-logo-full-color-rgb.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Adventures in Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ucdavisdatalab/adventures_in_data_science" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Overview</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/required-software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Required Software</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Fundamentals</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/01_command-line.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Command Line</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/02_version-control.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Version Control</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/03_r-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Introduction to R</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/04_programming-foundations.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Core Programming Concepts</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/05_hello-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Hello, Data!</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/06_data-structures.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Structures</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/07_data-forensics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Data Forensics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/08_data-visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Data Visualization</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/09_data-from-the-web.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Getting Data from the Web</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/10_strings-regex.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Strings and Regular Expressions</span></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Special Topics</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/11_optical-character-recognition.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Optical Character Recognition</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/12_statistics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Statistics</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/13_reshaping-tabular-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Reshaping Tabular Data</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/14_network-analysis.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Network Analysis</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/15_natural-language-processing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Natural Language Processing</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../chapters/16_geospatial-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Geospatial Data</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
<div class="quarto-sidebar-footer"><div class="sidebar-footer-item">
<hr>
<p><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank"> <img alt="CC BY-SA 4.0" src="https://img.shields.io/badge/License-CC%20BY--NC--SA%204.0-lightgrey.svg" style="float: right; padding-right: 10px;"> </a></p>
</div></div></nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#using-a-file-manifest" id="toc-using-a-file-manifest" class="nav-link active" data-scroll-target="#using-a-file-manifest"><span class="header-section-number">15.1</span> Using a File Manifest</a></li>
  <li><a href="#loading-a-corpus" id="toc-loading-a-corpus" class="nav-link" data-scroll-target="#loading-a-corpus"><span class="header-section-number">15.2</span> Loading a Corpus</a></li>
  <li><a href="#preprocessing" id="toc-preprocessing" class="nav-link" data-scroll-target="#preprocessing"><span class="header-section-number">15.3</span> Preprocessing</a>
  <ul class="collapse">
  <li><a href="#tokenizing-and-bags-of-words" id="toc-tokenizing-and-bags-of-words" class="nav-link" data-scroll-target="#tokenizing-and-bags-of-words"><span class="header-section-number">15.3.1</span> Tokenizing and Bags of Words</a></li>
  <li><a href="#text-normalization" id="toc-text-normalization" class="nav-link" data-scroll-target="#text-normalization"><span class="header-section-number">15.3.2</span> Text Normalization</a></li>
  <li><a href="#stop-words" id="toc-stop-words" class="nav-link" data-scroll-target="#stop-words"><span class="header-section-number">15.3.3</span> Stop Words</a></li>
  <li><a href="#tokenizers" id="toc-tokenizers" class="nav-link" data-scroll-target="#tokenizers"><span class="header-section-number">15.3.4</span> Tokenizers</a></li>
  <li><a href="#document-chunking-and-n-grams" id="toc-document-chunking-and-n-grams" class="nav-link" data-scroll-target="#document-chunking-and-n-grams"><span class="header-section-number">15.3.5</span> Document Chunking and N-grams</a></li>
  </ul></li>
  <li><a href="#counting-terms" id="toc-counting-terms" class="nav-link" data-scroll-target="#counting-terms"><span class="header-section-number">15.4</span> Counting Terms</a>
  <ul class="collapse">
  <li><a href="#term-frequency" id="toc-term-frequency" class="nav-link" data-scroll-target="#term-frequency"><span class="header-section-number">15.4.1</span> Term Frequency</a></li>
  <li><a href="#plotting-term-frequency" id="toc-plotting-term-frequency" class="nav-link" data-scroll-target="#plotting-term-frequency"><span class="header-section-number">15.4.2</span> Plotting Term Frequency</a></li>
  <li><a href="#comparing-term-frequencies-across-documents" id="toc-comparing-term-frequencies-across-documents" class="nav-link" data-scroll-target="#comparing-term-frequencies-across-documents"><span class="header-section-number">15.4.3</span> Comparing Term Frequencies Across Documents</a></li>
  </ul></li>
  <li><a href="#text-mining-pipepline" id="toc-text-mining-pipepline" class="nav-link" data-scroll-target="#text-mining-pipepline"><span class="header-section-number">15.5</span> Text Mining Pipepline</a></li>
  <li><a href="#document-term-matrix" id="toc-document-term-matrix" class="nav-link" data-scroll-target="#document-term-matrix"><span class="header-section-number">15.6</span> Document Term Matrix</a></li>
  <li><a href="#corpus-analytics" id="toc-corpus-analytics" class="nav-link" data-scroll-target="#corpus-analytics"><span class="header-section-number">15.7</span> Corpus Analytics</a>
  <ul class="collapse">
  <li><a href="#corpus-term-counts" id="toc-corpus-term-counts" class="nav-link" data-scroll-target="#corpus-term-counts"><span class="header-section-number">15.7.1</span> Corpus Term Counts</a></li>
  <li><a href="#tf-idf-scores" id="toc-tf-idf-scores" class="nav-link" data-scroll-target="#tf-idf-scores"><span class="header-section-number">15.7.2</span> TF-IDF Scores</a></li>
  <li><a href="#unique-terms-in-a-document" id="toc-unique-terms-in-a-document" class="nav-link" data-scroll-target="#unique-terms-in-a-document"><span class="header-section-number">15.7.3</span> Unique Terms in a Document</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/ucdavisdatalab/adventures_in_data_science/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/ucdavisdatalab/adventures_in_data_science/blob/main/chapters/15_natural-language-processing.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../chapters/11_optical-character-recognition.html">Special Topics</a></li><li class="breadcrumb-item"><a href="../chapters/15_natural-language-processing.html"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Natural Language Processing</span></a></li></ol></nav>
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Natural Language Processing</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>This lecture is designed to introduce you to the basics of preprocessing and analyzing natural language text data.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Learning Goals">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Learning Goals
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>After this lesson, you should be able to:</p>
<ul>
<li>Be able to identify patterns in unstructured data</li>
<li>Know the general workflow for cleaning texts in R, which entails:
<ul>
<li>Tokenizing words</li>
<li>Determining and applying stop words</li>
<li>Normalizing, lemmatizing, and stemming texts</li>
<li>Creating a document-term matrix</li>
</ul></li>
<li>Understand how preprocessing steps impact analysis</li>
<li>Get high-level data about text documents (term frequencies, TF-IDF scores)</li>
</ul>
</div>
</div>
</div>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-2-contents" aria-controls="callout-2" aria-expanded="true" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Required Data Sets and Packages
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-2" class="callout-2-contents callout-collapse collapse show">
<div class="callout-body-container callout-body">
<p>The examples in this chapter use the following data sets and packages.</p>
<p>Data sets:</p>
<ul>
<li><a href="https://github.com/ucdavisdatalab/adventures_in_data_science/blob/main/data/C19_novels_manifest.csv"><code>C19_novels_manifest.csv</code></a></li>
<li><a href="https://github.com/ucdavisdatalab/adventures_in_data_science/blob/main/data/C19_novels_raw.rds"><code>C19_novels_raw.rds</code></a></li>
</ul>
<p>For each data set, go to the linked page and click the “Download raw file” button.</p>
<p>Packages:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tm"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"tokenizers"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
<section id="using-a-file-manifest" class="level2" data-number="15.1">
<h2 data-number="15.1" class="anchored" data-anchor-id="using-a-file-manifest"><span class="header-section-number">15.1</span> Using a File Manifest</h2>
<p>In this lesson, we’ll be preparing a collection of texts for computational analysis. Before we start that work in full, we’re going to load in a file manifest, which will help us a) identify what’s in our collection; and b) keep track of things like the order of texts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>manifest <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/C19_novels_manifest.csv"</span>, <span class="at">row.names =</span> <span class="dv">1</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>manifest</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   last_name  first_name                         title year genre
1   Beckford     William                        Vathek 1786     G
2  Radcliffe         Ann              ASicilianRomance 1790     G
3  Radcliffe         Ann         TheMysteriesofUdolpho 1794     G
4      Lewis     Matthew                       TheMonk 1795     G
5     Austen        Jane           SenseandSensibility 1811     N
6    Shelley        Mary                  Frankenstein 1818     G
7      Scott      Walter                       Ivanhoe 1820     N
8        Poe  EdgarAllen TheNarrativeofArthurGordonPym 1838     N
9     Bronte       Emily              WutheringHeights 1847     G
10 Hawthorne   Nathaniel      TheHouseoftheSevenGables 1851     N
11   Gaskell   Elizabeth                 NorthandSouth 1854     N
12   Collins      Wilkie               TheWomaninWhite 1860     N
13   Dickens     Charles             GreatExpectations 1861     N
14     James       Henry               PortraitofaLady 1881     N
15 Stevenson RobertLouis                TreasureIsland 1882     N
16 Stevenson RobertLouis                 JekyllandHyde 1886     G
17     Wilde       Oscar        ThePictureofDorianGray 1890     G
18    Stoker        Bram                       Dracula 1897     G</code></pre>
</div>
</div>
<p>As you can see, in addition to the author and title listings, we also have a genre tag. <code>G</code> is for “Gothic” literature, while <code>N</code> is “not Gothic.” Let’s convert the datatype for the genre column into a factor, which will make life easier later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>manifest<span class="sc">$</span>genre <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(manifest<span class="sc">$</span>genre)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-a-corpus" class="level2" data-number="15.2">
<h2 data-number="15.2" class="anchored" data-anchor-id="loading-a-corpus"><span class="header-section-number">15.2</span> Loading a Corpus</h2>
<p>With our metadata loaded, it’s time to bring in our files. We’ll be using files stored in an RDS format, though you could also load straight from a directory with a combination of <code>lapply</code> and <code>readLines</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/C19_novels_raw.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading our files like this will create a giant list of vectors, where each vector is a full text file. Those vectors are chunked by paragraph right now, but for our purposes it would be easier if each vector was a single stream of text (like the output of <code>ocr</code>, if you’ll remember). We can collapse them together with <code>paste</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>files <span class="ot">&lt;-</span> <span class="fu">lapply</span>(files, paste, <span class="at">collapse =</span> <span class="st">" "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From here, we can wrap these files in a special “corpus” object, which the tm package enables (a corpus is a large collection of texts). A tm corpus works somewhat like a database. It has a section for “content”, which contains text data, as well as various metadata sections, which we can populate with additional information about our texts, if we wished. Taken together, these features make it easy to streamline workflows with text data.</p>
<p>To make a corpus with tm, we call the <code>Corpus</code> function, specifying with <code>VectorSource</code> (because our texts are vectors):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tm"</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>corpus <span class="ot">&lt;-</span> <span class="fu">Corpus</span>(<span class="fu">VectorSource</span>(files))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here’s a high-level glimpse at what’s in this object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>corpus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;SimpleCorpus&gt;&gt;
Metadata:  corpus specific: 1, document level (indexed): 0
Content:  documents: 18</code></pre>
</div>
</div>
<p>Zooming in to metadata about a text in the corpus:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>corpus[[<span class="dv">6</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;PlainTextDocument&gt;&gt;
Metadata:  7
Content:  chars: 424017</code></pre>
</div>
</div>
<p>Not much here so far, but we’ll add more later.</p>
<p>Finally, we can get content from a text:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"stringr"</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">str_sub</span>(corpus[[<span class="dv">6</span>]]<span class="sc">$</span>content, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "FRANKENSTEIN:  OR,  THE MODERN PROMETHEUS.  BY MARY W. SHELLEY.  PREFACE.  The event on which this fiction is founded, has been supposed, by Dr. Darwin, and some of the physiological writers of Germany, as not of impossible occurrence. I shall not be supposed as according the remotest degree of serious faith to such an imagination; yet, in assuming it as the basis of a work of fancy, I have not considered myself as merely weaving a series of supernatural terrors. The event on which the interest "</code></pre>
</div>
</div>
<p>In this last view, you can see that the text file is still formatted (at least we didn’t have to OCR it!). This formatting is unwieldy and worse, it makes it so we can’t really access the elements that comprise each novel. We’ll need to do more work to preprocess our texts before we can analyze them.</p>
</section>
<section id="preprocessing" class="level2" data-number="15.3">
<h2 data-number="15.3" class="anchored" data-anchor-id="preprocessing"><span class="header-section-number">15.3</span> Preprocessing</h2>
<p>Part of preprocessing entails making decisions about the kinds of information we want to know about our data. Knowing what information we want often guides the way we structure data. Put another way: <em>research questions drive preprocessing</em>.</p>
<section id="tokenizing-and-bags-of-words" class="level3" data-number="15.3.1">
<h3 data-number="15.3.1" class="anchored" data-anchor-id="tokenizing-and-bags-of-words"><span class="header-section-number">15.3.1</span> Tokenizing and Bags of Words</h3>
<p>For example, it’d be helpful to know how many words are in each novel, which might enable us to study patterns and differences between authors’ styles. To get word counts, we need to split the text vectors into individual words. One way to do this would be to first strip out everything in each novel that isn’t an alphabetic character or a space. Let’s grab one text to experiment with.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>frankenstein <span class="ot">&lt;-</span> corpus[[<span class="dv">6</span>]]<span class="sc">$</span>content</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>frankenstein <span class="ot">&lt;-</span> <span class="fu">str_replace_all</span>(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  frankenstein, <span class="at">pattern =</span> <span class="st">"[^A-Za-z]"</span>, <span class="at">replacement =</span> <span class="st">" "</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>From here, it would be easy enough to count the words in a novel by splitting its vector on spaces, removing empty elements in the vector, and calling <code>length</code> on the vector. The end result is what we call a <strong>bag of words</strong>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>frankenstein <span class="ot">&lt;-</span> <span class="fu">str_split</span>(frankenstein, <span class="st">" "</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>frankenstein <span class="ot">&lt;-</span> <span class="fu">lapply</span>(frankenstein, <span class="cf">function</span>(x) x[x <span class="sc">!=</span> <span class="st">""</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="fu">length</span>(frankenstein[[<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 76015</code></pre>
</div>
</div>
<p>And here are the first nine words (or “tokens”):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>frankenstein[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "FRANKENSTEIN" "OR"           "THE"          "MODERN"       "PROMETHEUS"  
[6] "BY"           "MARY"         "W"            "SHELLEY"     </code></pre>
</div>
</div>
</section>
<section id="text-normalization" class="level3" data-number="15.3.2">
<h3 data-number="15.3.2" class="anchored" data-anchor-id="text-normalization"><span class="header-section-number">15.3.2</span> Text Normalization</h3>
<p>While easy, producing our bag of words this way is a bit clunky. And further, this process can’t handle contractions (“I’m”, “don’t”, “that’s”) or differences in capitalization.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>frankenstein[[<span class="dv">1</span>]][<span class="dv">188</span><span class="sc">:</span><span class="dv">191</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Midsummer" "Night"     "s"         "Dream"    </code></pre>
</div>
</div>
<p>Should be:</p>
<pre><code>Midsummer Night's Dream</code></pre>
<p>And</p>
<pre><code>"FRANKENSTEIN", "Frankenstein"</code></pre>
<p>Should be:</p>
<pre><code>"Frankenstein"</code></pre>
<p>Or, even better:</p>
<pre><code>frankenstein</code></pre>
<p>Typically, when we work with text data we want all of our words to be in the same case because this makes it easier to do things like counting operations. Remember that, to a computer, “Word” and “word” are two separate words, and if we want to count them together, we need to pick one version or the other. Making all words lowercase (even proper nouns) is the standard. Doing this is part of what’s called text <strong>normalization</strong>. (Other forms of normalization might entail handling orthographic differences between British and American English, like “color” and “colour”.)</p>
<p>As for contractions, we have some decisions to make. On the one hand, it’s important to retain as much information as we can about the original text, so keeping “don’t” or “what’s” (which would be “don t” and “what s” in our current method) is important. One way corpus linguists handle these words is to <strong>lemmatize</strong> them. Lemmatizing involves removing inflectional endings to return words to their base form:</p>
<ul>
<li>car, cars, car’s, cars’ =&gt; car</li>
<li>don’t =&gt; do</li>
</ul>
<p>This is a helpful step if what we’re primarily interested in is doing a high- level analysis of semantics. On the other hand, though, many words that feature contractions are high-frequency function words, which don’t have much meaning beyond the immediate context of a sentence or two. Words like “that’s” or “won’t” appear in huge numbers in text data, but they don’t carry much information in and of themselves—it may in fact be the case that we could get rid of them entirely…</p>
</section>
<section id="stop-words" class="level3" data-number="15.3.3">
<h3 data-number="15.3.3" class="anchored" data-anchor-id="stop-words"><span class="header-section-number">15.3.3</span> Stop Words</h3>
<p>…and indeed this is the case! When structuring text data to study it at scale, it’s common to remove, or <strong>stop out</strong>, words that don’t have much meaning. This makes it much easier to identify significant (i.e.&nbsp;unique) features in a text, without having to swim through all the noise of “the” or “that,” which would almost always show up as the highest-occurring words in an analysis. But what words should we remove? Ultimately, this depends on your text data. We can usually assume that function words will be on our list of <strong>stop words</strong>, but it may be that you’ll have to add or subtract others depending on your data and, of course, your research question.</p>
<p>The <code>tm</code> package has a good starting list. Let’s look at the first 100 words.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">stopwords</span>(<span class="st">"SMART"</span>), <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  [1] "a"            "a's"          "able"         "about"        "above"       
  [6] "according"    "accordingly"  "across"       "actually"     "after"       
 [11] "afterwards"   "again"        "against"      "ain't"        "all"         
 [16] "allow"        "allows"       "almost"       "alone"        "along"       
 [21] "already"      "also"         "although"     "always"       "am"          
 [26] "among"        "amongst"      "an"           "and"          "another"     
 [31] "any"          "anybody"      "anyhow"       "anyone"       "anything"    
 [36] "anyway"       "anyways"      "anywhere"     "apart"        "appear"      
 [41] "appreciate"   "appropriate"  "are"          "aren't"       "around"      
 [46] "as"           "aside"        "ask"          "asking"       "associated"  
 [51] "at"           "available"    "away"         "awfully"      "b"           
 [56] "be"           "became"       "because"      "become"       "becomes"     
 [61] "becoming"     "been"         "before"       "beforehand"   "behind"      
 [66] "being"        "believe"      "below"        "beside"       "besides"     
 [71] "best"         "better"       "between"      "beyond"       "both"        
 [76] "brief"        "but"          "by"           "c"            "c'mon"       
 [81] "c's"          "came"         "can"          "can't"        "cannot"      
 [86] "cant"         "cause"        "causes"       "certain"      "certainly"   
 [91] "changes"      "clearly"      "co"           "com"          "come"        
 [96] "comes"        "concerning"   "consequently" "consider"     "considering" </code></pre>
</div>
</div>
<p>That looks pretty comprehensive so far, though the only way we’ll know whether it’s a good match for our corpus is to process our corpus with it. At first glance, the extra random letters in this list seem like they could be a big help, on the off chance there’s some noise from OCR. If you look at the first novel in the corpus, for example, there are a bunch of stray <em>p</em>’s, which is likely from a pattern for marking pages (“p.&nbsp;7”):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="fu">str_sub</span>(corpus[[<span class="dv">1</span>]]<span class="sc">$</span>content, <span class="at">start =</span> <span class="dv">1</span>, <span class="at">end =</span> <span class="dv">1000</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>VATHEK;  AN ARABIAN TALE,    BY  WILLIAM BECKFORD, ESQ.    p. 7VATHEK.  Vathek, ninth Caliph [7a] of the race of the Abassides, was the son of Motassem, and the grandson of Haroun Al Raschid.  From an early accession to the throne, and the talents he possessed to adorn it, his subjects were induced to expect that his reign would be long and happy.  His figure was pleasing and majestic; but when he was angry, one of his eyes became so terrible [7b] that no person could bear to behold it; and the wretch upon whom it was fixed instantly fell backward, and sometimes expired.  For fear, however, of depopulating his dominions, and making his palace desolate, he but rarely gave way to his anger.  Being much addicted to women, and the pleasures of the table, he sought by his affability to procure agreeable companions; and he succeeded the better, p. 8as his generosity was unbounded and his indulgences unrestrained; for he was by no means scrupulous: nor did he think, with the Caliph Omar Ben A</code></pre>
</div>
</div>
<p>Our stop word list would take care of this. With it, we could return to our original collection of novels, split them on spaces as before, and filter out everything that’s stored in our <code>stop_list</code> variable. Before we did the filtering, though, we’d need to transform the novels into lowercase (which can be done with stringr’s <code>str_to_lower</code> function).</p>
</section>
<section id="tokenizers" class="level3" data-number="15.3.4">
<h3 data-number="15.3.4" class="anchored" data-anchor-id="tokenizers"><span class="header-section-number">15.3.4</span> Tokenizers</h3>
<p>This whole process is ultimately straightforward so far, but it would be nice to collapse all its steps. Luckily, there are packages we can use to streamline our process. The tokenizers package has functions that split a text vector, turn words into lowercase forms, and remove stop words, all in a few lines of code. Further, we can combine these functions with a special <code>tm_map</code> function in the tm package, which will globally apply our changes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tokenizers"</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>cleaned_corpus <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  corpus,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  tokenize_words,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">stopwords =</span> <span class="fu">stopwords</span>(<span class="st">'SMART'</span>),</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">lowercase =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip_punct =</span> <span class="cn">TRUE</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">strip_numeric =</span> <span class="cn">TRUE</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You may see a “transformation drops documents” warning after this. You can disregard it. It has to do with the way <code>tm</code> references text changes against a corpus’s metadata, which we’ve left blank.</p>
<p>We can compare our tokenized output with the text data we had been working with earlier:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">list</span>(</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">untokenized =</span> frankenstein[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>],</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">tokenized =</span> cleaned_corpus[[<span class="dv">6</span>]]<span class="sc">$</span>content[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$untokenized
[1] "FRANKENSTEIN" "OR"           "THE"          "MODERN"       "PROMETHEUS"  
[6] "BY"           "MARY"         "W"            "SHELLEY"     

$tokenized
[1] "frankenstein" "modern"       "prometheus"   "mary"         "shelley"     </code></pre>
</div>
</div>
<p>From the title alone we can see how much of a difference tokenizing with stop words makes. And while we lose a bit of information by doing this, what we can is a much clearer picture of key words we’d want to further analyze.</p>
</section>
<section id="document-chunking-and-n-grams" class="level3" data-number="15.3.5">
<h3 data-number="15.3.5" class="anchored" data-anchor-id="document-chunking-and-n-grams"><span class="header-section-number">15.3.5</span> Document Chunking and N-grams</h3>
<p>Finally, it’s possible to change the way we separate out our text data. Instead of tokenizing on words, we could use the tokenizers package to break apart our texts on paragraphs (<code>tokenize_paragraphs</code>), sentences (<code>tokenize_sentences</code>), and more. There might be valuable information to be learned about the average sentence length of a novel, for example, so we might chunk it accordingly.</p>
<p>We might also want to see whether a text contains repeated phrases, or if two or three words often occur in the same sequence. We could investigate this by adjusting the window around which we tokenize individual words. So far we’ve used the “unigram,” or a single word, as our basic unit of counting, but we could break our texts into “bigrams” (two word phrases), “trigrams” (three word phrases), or, well any sequence of <span class="math inline">\(n\)</span> units. Generally, you’ll see these sequences referred to as <strong>n-grams</strong>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>frankenstein_bigrams <span class="ot">&lt;-</span> <span class="fu">tokenize_ngrams</span>(</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>  corpus[[<span class="dv">6</span>]]<span class="sc">$</span>content,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">n =</span> <span class="dv">2</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">stopwords =</span> <span class="fu">stopwords</span>(<span class="st">"SMART"</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here, <code>n = 2</code> sets the n-gram window at two:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>frankenstein_bigrams[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "frankenstein modern"   "modern prometheus"     "prometheus mary"      
 [4] "mary shelley"          "shelley preface"       "preface event"        
 [7] "event fiction"         "fiction founded"       "founded supposed"     
[10] "supposed dr"           "dr darwin"             "darwin physiological" 
[13] "physiological writers" "writers germany"       "germany impossible"   
[16] "impossible occurrence" "occurrence supposed"   "supposed remotest"    
[19] "remotest degree"       "degree faith"         </code></pre>
</div>
</div>
<p>Note though that, for this function, we’d need to do some preprocessing on our own to remove numeric characters and punctuation; <code>tokenize_ngrams</code> won’t do it for us.</p>
</section>
</section>
<section id="counting-terms" class="level2" data-number="15.4">
<h2 data-number="15.4" class="anchored" data-anchor-id="counting-terms"><span class="header-section-number">15.4</span> Counting Terms</h2>
<p>Let’s return to our single word counts. Now that we’ve transformed our novels into bags of single words, we can start with some analysis. Simply counting the number of times a word appears in some data can tell us a lot about a text. The following steps should feel familiar: we did them with OCR.</p>
<p>Let’s look at <em>Wuthering Heights</em>, which is our ninth text:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"tidyverse"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>wuthering_heights <span class="ot">&lt;-</span> <span class="fu">table</span>(cleaned_corpus[[<span class="dv">9</span>]]<span class="sc">$</span>content)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>wuthering_heights <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">word =</span> <span class="fu">names</span>(wuthering_heights),</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">count =</span> <span class="fu">as.numeric</span>(wuthering_heights)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>wuthering_heights <span class="ot">&lt;-</span> <span class="fu">arrange</span>(wuthering_heights, <span class="fu">desc</span>(count))</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(wuthering_heights, <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         word count
1  heathcliff   422
2      linton   348
3   catherine   339
4          mr   312
5      master   185
6     hareton   169
7    answered   156
8        till   151
9       house   144
10       door   133
11        mrs   133
12     joseph   130
13       miss   129
14       time   127
15       back   121
16    thought   118
17      cathy   117
18       good   117
19    replied   117
20   earnshaw   116
21       eyes   116
22      cried   114
23      young   107
24        day   106
25     father   106
26      asked   105
27       make   105
28      edgar   104
29      night   104
30       made   102</code></pre>
</div>
</div>
<p>Looks good! The two main characters in this novel are named Heathcliff and Catherine, so it makes sense that these words would appear a lot. You can see, however, that we might want to fine tune our stop word list so that it removes “mr” and “mrs” from the text. Though again, it depends on our research question. If we’re exploring gender roles in nineteenth-century literature, we’d probably keep those words in.</p>
<p>In addition to fine tuning stop words, pausing here at these counts would be a good way to check whether some other form of textual noise is present in your data, which you haven’t yet caught. There’s nothing like that here, but you might imagine how consistent OCR noise could make itself known in this view.</p>
<section id="term-frequency" class="level3" data-number="15.4.1">
<h3 data-number="15.4.1" class="anchored" data-anchor-id="term-frequency"><span class="header-section-number">15.4.1</span> Term Frequency</h3>
<p>After you’ve done your fine tuning, it would be good to get a <strong>term frequency</strong> number for each word in this data frame. Raw counts are nice, but expressing those counts in proportion to the total words in a document will tell us more information about a word’s contribution to the document as a whole. We can get term frequencies for our words by dividing a word’s count by document length (which is the sum of all words in the document).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>wuthering_heights<span class="sc">$</span>term_frequency <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  wuthering_heights<span class="sc">$</span>count,</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) x <span class="sc">/</span> <span class="fu">sum</span>(wuthering_heights<span class="sc">$</span>count)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(wuthering_heights, <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         word count term_frequency
1  heathcliff   422    0.009619549
2      linton   348    0.007932709
3   catherine   339    0.007727552
4          mr   312    0.007112084
5      master   185    0.004217101
6     hareton   169    0.003852379
7    answered   156    0.003556042
8        till   151    0.003442066
9       house   144    0.003282500
10       door   133    0.003031754
11        mrs   133    0.003031754
12     joseph   130    0.002963368
13       miss   129    0.002940573
14       time   127    0.002894983
15       back   121    0.002758212
16    thought   118    0.002689827
17      cathy   117    0.002667031
18       good   117    0.002667031
19    replied   117    0.002667031
20   earnshaw   116    0.002644236
21       eyes   116    0.002644236
22      cried   114    0.002598646
23      young   107    0.002439080
24        day   106    0.002416285
25     father   106    0.002416285
26      asked   105    0.002393490
27       make   105    0.002393490
28      edgar   104    0.002370695
29      night   104    0.002370695
30       made   102    0.002325104</code></pre>
</div>
</div>
</section>
<section id="plotting-term-frequency" class="level3" data-number="15.4.2">
<h3 data-number="15.4.2" class="anchored" data-anchor-id="plotting-term-frequency"><span class="header-section-number">15.4.2</span> Plotting Term Frequency</h3>
<p>Let’s plot the top 50 words in <em>Wuthering Heights</em>. We’ll call <code>fct_reorder</code> in the <code>aes</code> layer of <code>ggplot</code> to sort words in the descending order of their term frequency.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(wuthering_heights[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ]) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_reorder</span>(word, <span class="sc">-</span>term_frequency), <span class="at">y =</span> term_frequency) <span class="sc">+</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span><span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 50 words in Wuthering Heights"</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Word"</span>,</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Term Frequency"</span></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15_natural-language-processing_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>This is a good start for creating a high-level view of the novel, but further tuning might be in order. We’ve already mentioned “mrs” and “mr” as two words that we could cut out of the text. Another option would be to collapse these two words together into a <strong>base form</strong> by <strong>stemming</strong> them. Though this would overweight their base form (which in this case is “mr”) in terms of term frequency, it would also free up space to see other terms in the document. Other examples of stemming words would be transforming “fishing”, “fished”, and “fisher” all into “fish.”</p>
<p>That said, like all preprocessing, lemmatizing words is an <em>interpretive decision</em>, which comes with its own consequences. Maybe it’s okay to transform “mr” and “mrs” into “mr” for some analyses, but it’s also the case that we’d be erasing potentially important gender differences in the text—and would do so by overweighting the masculine form of the word. Regardless of what you decide, it’s important to keep track of these decisions as you make them because they will impact the kinds of claims you make about your data later on.</p>
</section>
<section id="comparing-term-frequencies-across-documents" class="level3" data-number="15.4.3">
<h3 data-number="15.4.3" class="anchored" data-anchor-id="comparing-term-frequencies-across-documents"><span class="header-section-number">15.4.3</span> Comparing Term Frequencies Across Documents</h3>
<p>Term frequency is helpful if we want to start comparing words across two texts. We can make some comparisons by transforming the above code into a function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>term_table <span class="ot">&lt;-</span> <span class="cf">function</span>(text) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  term_tab <span class="ot">&lt;-</span> <span class="fu">table</span>(text)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  term_tab <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">word =</span> <span class="fu">names</span>(term_tab), <span class="at">count =</span> <span class="fu">as.numeric</span>(term_tab))</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  term_tab<span class="sc">$</span>term_frequency <span class="ot">&lt;-</span> <span class="fu">sapply</span>(</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    term_tab<span class="sc">$</span>count,</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) (x<span class="sc">/</span><span class="fu">sum</span>(term_tab<span class="sc">$</span>count))</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(term_tab, <span class="fu">desc</span>(count))</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We already have a term table for <em>Wuthering Heights</em>. Let’s make one for <em>Dracula</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>dracula <span class="ot">&lt;-</span> <span class="fu">term_table</span>(cleaned_corpus[[<span class="dv">18</span>]]<span class="sc">$</span>content)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dracula, <span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        word count term_frequency
1       time   387    0.007280458
2        van   321    0.006038829
3    helsing   299    0.005624953
4       back   261    0.004910076
5       room   231    0.004345699
6       good   225    0.004232824
7       lucy   225    0.004232824
8        man   224    0.004214012
9       dear   219    0.004119949
10      mina   217    0.004082324
11     night   217    0.004082324
12      hand   209    0.003931823
13      face   205    0.003856573
14      door   201    0.003781323
15      made   193    0.003630822
16      poor   192    0.003612010
17     sleep   190    0.003574385
18      eyes   186    0.003499135
19    looked   185    0.003480322
20    friend   183    0.003442697
21     great   182    0.003423884
22  jonathan   182    0.003423884
23        dr   178    0.003348634
24    things   174    0.003273384
25      make   163    0.003066446
26       day   160    0.003010008
27 professor   155    0.002915946
28     count   153    0.002878320
29     found   153    0.002878320
30   thought   153    0.002878320</code></pre>
</div>
</div>
<p>Now we can compare the relative frequency of a word across two novels:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>comparison_words <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"dark"</span>, <span class="st">"night"</span>, <span class="st">"ominous"</span>)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> comparison_words) {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  wh <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">wh =</span> <span class="fu">subset</span>(wuthering_heights, word <span class="sc">==</span> i))</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  drac <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">drac =</span> <span class="fu">subset</span>(dracula, word <span class="sc">==</span> i))</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(wh)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(drac)</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$wh
    word count term_frequency
183 dark    32   0.0007294445

$drac
   word count term_frequency
90 dark    77    0.001448566

$wh
    word count term_frequency
29 night   104    0.002370695

$drac
    word count term_frequency
11 night   217    0.004082324

$wh
        word count term_frequency
7283 ominous     1   2.279514e-05

$drac
        word count term_frequency
7217 ominous     1   1.881255e-05</code></pre>
</div>
</div>
<p>Not bad! We might be able to make a few generalizations from this, but to say anything definitively, we’ll need to scale our method. Doing so wouldn’t be easy with this setup as it stands now. While it’s true that we could write some functions to roll through these two data frames and systematically compare the words in each, it would take a lot of work to do so. Luckily, the <code>tm</code> package (which we’ve used to make our stop word list) features generalized functions for just this kind of thing.</p>
</section>
</section>
<section id="text-mining-pipepline" class="level2" data-number="15.5">
<h2 data-number="15.5" class="anchored" data-anchor-id="text-mining-pipepline"><span class="header-section-number">15.5</span> Text Mining Pipepline</h2>
<p>Before going further, we should note that <code>tm</code> has its own functions for preprocessing texts. To send raw files directly through those functions, you’d call <code>tm_map</code> in conjunction with these functions. You can think of <code>tm_map</code> as a cognate to the <code>apply</code> family.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>corpus_2 <span class="ot">&lt;-</span> <span class="fu">Corpus</span>(<span class="fu">VectorSource</span>(files))</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>corpus_2 <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(corpus_2, removeNumbers)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>corpus_2 <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(corpus_2, removeWords, <span class="fu">stopwords</span>(<span class="st">"SMART"</span>))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>corpus_2 <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(corpus_2, removePunctuation)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>corpus_2 <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(corpus_2, stripWhitespace)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Note the order of operations here: because our stop words list takes into account punctuated words, like “don’t” or “i’m”, we want to remove stop words <em>before</em> removing punctuation. If we didn’t do this, <code>removeWords</code> wouldn’t catch the un-punctuated “dont” or “im”. This won’t always be the case, since we can use different stop word lists, which may have a different set of terms, but in this instance, the order in which we preprocess matters.</p>
<p>Preparing your text files like this would be fine, and indeed sometimes it’s preferable to sequentially step through each part of the preprocessing workflow. That said, <code>tokenizers</code> manages the order of operations above on its own and its preprocessing functions are generally a bit faster to run (in particular, <code>removeWords</code> is quite slow in comparison to <code>tokenize_words</code>).</p>
<p>There is, however, one caveat to using <code>tokenizers</code>. It splits documents up to do text cleaning, but other functions in <code>tm</code> require non-split documents. If we use <code>tokenizers</code>, then, we need to do a quick workaround with <code>paste</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>cleaned_corpus <span class="ot">&lt;-</span> <span class="fu">lapply</span>(cleaned_corpus, paste, <span class="at">collapse =</span> <span class="st">" "</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then reformat that output as a corpus object:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>cleaned_corpus <span class="ot">&lt;-</span> <span class="fu">Corpus</span>(<span class="fu">VectorSource</span>(cleaned_corpus))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Ultimately, it’s up to you to decide what workflow makes sense. Personally, I (Tyler) like to do exploratory preprocessing steps with <code>tokenizers</code>, often with a sample set of all the documents. Then, once I’ve settled on my stop word list and so forth, I reprocess all my files with the <code>tm</code>-specific functions above.</p>
<p>Regardless of what workflow you choose, preprocessing can take a while, so now would be a good place to save your data. That way, you can retrieve your corpus later on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(cleaned_corpus, <span class="st">"data/C19_novels_cleaned.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Loading it back in is straightforward:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>cleaned_corpus <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/C19_novels_cleaned.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="document-term-matrix" class="level2" data-number="15.6">
<h2 data-number="15.6" class="anchored" data-anchor-id="document-term-matrix"><span class="header-section-number">15.6</span> Document Term Matrix</h2>
<p>The advantage of using a <code>tm</code> corpus is that it makes comparing data easier. Remember that, in our old workflow, looking at the respective term frequencies in two documents entailed a fair bit of code. And further, we left off before generalizing that code to the corpus as a whole. But what if we wanted to look at a term across multiple documents?</p>
<p>To do so, we need to create what’s called a <strong>document-term matrix</strong>, or DTM. A DTM describes the frequency of terms across an entire corpus (rather than just one document). Rows of the matrix correspond to documents, while columns correspond to the terms. For a given document, we count the number of times that term appears and enter that number in the column in question. We do this <em>even if</em> the count is 0; key to the way a DTM works is that it’s a <em>corpus-wide</em> representation of text data, so it matters if a text does or doesn’t contain a term.</p>
<p>Here’s a simple example with three documents:</p>
<ul>
<li>Document 1: “I like cats”</li>
<li>Document 2: “I like dogs”</li>
<li>Document 3: “I like both cats and dogs”</li>
</ul>
<p>Transforming these into a document-term matrix would yield:</p>
<table class="table-striped table-hover caption-top table">
<thead>
<tr class="header">
<th style="text-align: center;">n_doc</th>
<th style="text-align: center;">I</th>
<th style="text-align: center;">like</th>
<th style="text-align: center;">both</th>
<th style="text-align: center;">cats</th>
<th style="text-align: center;">and</th>
<th style="text-align: center;">dogs</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
</tr>
<tr class="even">
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">0</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;">3</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>
<p>Representing texts in this way is incredibly useful because it enables us to easily discern similarities and differences in our corpus. For example, we can see that each of the above documents contain the words “I” and “like.” Given that, if we wanted to know what makes documents unique, we can ignore those two words and focus on the rest of the values.</p>
<p>Now, imagine doing this for thousands of words! What patterns might emerge?</p>
<p>Let’s try it on our corpus. We can transform a <code>tm</code> corpus object into a DTM by calling <code>DocumentTermMatrix</code>.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p><code>DocumentTermMatrix</code> is one of the functions in the tm package that requires non-split documents, so before you call it make sure you know how you’ve preprocessed your texts!</p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">&lt;-</span> <span class="fu">DocumentTermMatrix</span>(cleaned_corpus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This object is quite similar to the one that results from <code>Corpus</code>: it contains a fair bit of metadata, as well as an all-important <code>dimnames</code> field, which records the documents in the matrix and the entire term vocabulary. We access all of this information with the same syntax we use for data frames.</p>
<p>Let’s look around a bit and get some high-level info.</p>
</section>
<section id="corpus-analytics" class="level2" data-number="15.7">
<h2 data-number="15.7" class="anchored" data-anchor-id="corpus-analytics"><span class="header-section-number">15.7</span> Corpus Analytics</h2>
<p>Number of columns in the DTM (that is, the vocabulary size):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>dtm<span class="sc">$</span>ncol</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 34925</code></pre>
</div>
</div>
<p>Number of rows in the DTM (that is, the number of documents this matrix represents):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>dtm<span class="sc">$</span>nrow</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 18</code></pre>
</div>
</div>
<p>Right now, the document names are just a numbers in a vector:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dtm<span class="sc">$</span>dimnames<span class="sc">$</span>Docs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "1"  "2"  "3"  "4"  "5"  "6"  "7"  "8"  "9"  "10" "11" "12" "13" "14" "15"
[16] "16" "17" "18"</code></pre>
</div>
</div>
<p>But they’re ordered according to the sequence in which the corpus was originally created. This means we can use our metadata from way back when to associate a document with its title:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>dtm<span class="sc">$</span>dimnames<span class="sc">$</span>Docs <span class="ot">&lt;-</span> manifest<span class="sc">$</span>title</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>dtm<span class="sc">$</span>dimnames<span class="sc">$</span>Docs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "Vathek"                        "ASicilianRomance"             
 [3] "TheMysteriesofUdolpho"         "TheMonk"                      
 [5] "SenseandSensibility"           "Frankenstein"                 
 [7] "Ivanhoe"                       "TheNarrativeofArthurGordonPym"
 [9] "WutheringHeights"              "TheHouseoftheSevenGables"     
[11] "NorthandSouth"                 "TheWomaninWhite"              
[13] "GreatExpectations"             "PortraitofaLady"              
[15] "TreasureIsland"                "JekyllandHyde"                
[17] "ThePictureofDorianGray"        "Dracula"                      </code></pre>
</div>
</div>
<p>With this information associated, we can use <code>inspect</code> to get a high-level view of the corpus:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">inspect</span>(dtm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 18, terms: 34925)&gt;&gt;
Non-/sparse entries: 145233/483417
Sparsity           : 77%
Maximal term length: 19
Weighting          : term frequency (tf)
Sample             :
                          Terms
Docs                       back day eyes good great long made man thought time
  Dracula                   261 160  186  225   182  147  193 224     153  387
  GreatExpectations         244 216  180  256   198  173  300 307     238  373
  Ivanhoe                    77 138  100  298   111  154  151 235      46  182
  NorthandSouth             184 257  197  316   179  211  234 270     332  423
  PortraitofaLady           210 241  226  520   421  187  381 317     302  339
  TheHouseoftheSevenGables   79 113   72  100   144  153  144 211      60  113
  TheMonk                    81 106  184   80    66  108  167  95      72  162
  TheMysteriesofUdolpho     117 167  225  186   164  359  316 213     341  367
  TheWomaninWhite           417 351  233  235   112  188  244 443     183  706
  WutheringHeights          121 106  116  117    63   97  102  88     118  127</code></pre>
</div>
</div>
<p>Of special note here is <strong>sparsity</strong>. Sparsity measures the amount of 0s in the data. This happens when a document does not contain a term that appears elsewhere in the corpus. In our case, of the 628,650 entries in this matrix, 80% of them are 0. Such is the way of working with DTMs: they’re big, expansive data structures that have a lot of empty space.</p>
<p>We can zoom in and filter on term counts with <code>findFreqTerms</code>. Here are terms that appear more than 1,000 times in the corpus:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="fu">findFreqTerms</span>(dtm, <span class="dv">1000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "answered" "appeared" "asked"    "back"     "day"      "dear"    
 [7] "death"    "door"     "eyes"     "face"     "father"   "felt"    
[13] "found"    "friend"   "gave"     "give"     "good"     "great"   
[19] "half"     "hand"     "hands"    "head"     "hear"     "heard"   
[25] "heart"    "hope"     "kind"     "knew"     "lady"     "leave"   
[31] "left"     "life"     "light"    "long"     "looked"   "love"    
[37] "made"     "make"     "man"      "men"      "mind"     "moment"  
[43] "morning"  "mother"   "night"    "part"     "passed"   "people"  
[49] "person"   "place"    "poor"     "present"  "put"      "replied" 
[55] "returned" "round"    "side"     "speak"    "stood"    "thing"   
[61] "thou"     "thought"  "till"     "time"     "told"     "turned"  
[67] "voice"    "woman"    "words"    "world"    "young"    "count"   
[73] "house"    "madame"   "room"     "sir"      "emily"    "margaret"
[79] "miss"     "mrs"      "isabel"  </code></pre>
</div>
</div>
<p>Using <code>findAssocs</code>, we can also track which words rise and fall in usage alongside a given word. (The number in the third argument position of this function is a cutoff for the strength of a correlation.)</p>
<p>Here’s “boat”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">findAssocs</span>(dtm, <span class="st">"boat"</span>, .<span class="dv">85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$boat
  thumping scoundrels     midday  direction 
      0.94       0.88       0.87       0.85 </code></pre>
</div>
</div>
<p>Here’s “writing” (there are a lot of terms, so we’ll limit to 15):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>writing <span class="ot">&lt;-</span> <span class="fu">findAssocs</span>(dtm, <span class="st">"writing"</span>, .<span class="dv">85</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>writing[[<span class="dv">1</span>]][<span class="dv">1</span><span class="sc">:</span><span class="dv">15</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     letter        copy    disposal   inquiries    bedrooms   hindrance 
       0.99        0.97        0.97        0.97        0.97        0.97 
   messages certificate    distrust     plainly    drawings   anonymous 
       0.97        0.97        0.96        0.96        0.96        0.96 
   ladyship  plantation    lodgings 
       0.96        0.96        0.96 </code></pre>
</div>
</div>
<section id="corpus-term-counts" class="level3" data-number="15.7.1">
<h3 data-number="15.7.1" class="anchored" data-anchor-id="corpus-term-counts"><span class="header-section-number">15.7.1</span> Corpus Term Counts</h3>
<p>From here, it would be useful to get a full count of all the terms in the corpus. We can transform the DTM into a matrix and then a data frame:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>term_counts <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dtm)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>term_counts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">sort</span>(<span class="fu">colSums</span>(term_counts), <span class="at">decreasing =</span> <span class="cn">TRUE</span>))</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>term_counts <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">newColName =</span> <span class="fu">rownames</span>(term_counts), term_counts)</span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(term_counts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"term"</span>, <span class="st">"count"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As before, let’s plot the top 50 terms in these counts, but this time, they will cover the entire corpus:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(term_counts[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ]) <span class="sc">+</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_reorder</span>(term, <span class="sc">-</span>count), <span class="at">y =</span> count) <span class="sc">+</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Top 50 words in 18 Nineteenth-Century Novels"</span>,</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Word"</span>,</span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Count"</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15_natural-language-processing_files/figure-html/unnamed-chunk-39-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>This looks good, though the words here are all pretty common. In fact, many of them are simply the most common words in the English language. “Time” is the 64th-most frequent word in English; “make” is the 50th. As it stands, then, this graph doesn’t tell us very much about the <em>specificity</em> of our particular collection of texts; if we ran the same process on English novels from the twentieth century, we’d probably produce very similar output.</p>
</section>
<section id="tf-idf-scores" class="level3" data-number="15.7.2">
<h3 data-number="15.7.2" class="anchored" data-anchor-id="tf-idf-scores"><span class="header-section-number">15.7.2</span> TF-IDF Scores</h3>
<p>Given this, if we want to know what makes our corpus special, we need a measure of uniqueness for the terms it contains. One of the most common ways to do this is to get what’s called a <strong>TF-IDF</strong> score (short for “term frequency-inverse document frequency”) for each term in our corpus. TF-IDF is a weighting method. It increases proportionally to the number of times a word appears in a document but is importantly offset by the number of documents in the corpus that contain this term. This offset adjusts for common words across a corpus, pushing their scores down while boosting the scores of rarer terms in the corpus.</p>
<p>Inverse document frequency can be expressed as:</p>
<p><span class="math display">\[\begin{align*}
idf_i = log(\frac{n}{df_i})
\end{align*}\]</span></p>
<p>Where <span class="math inline">\(idf_i\)</span> is the idf score for term <span class="math inline">\(i\)</span>, <span class="math inline">\(df_i\)</span> is the number of documents that contain <span class="math inline">\(i\)</span>, and <span class="math inline">\(n\)</span> is the total number of documents.</p>
<p>A TF-IDF score can be calculated by the following:</p>
<p><span class="math display">\[\begin{align*}
w_i,_j = tf_i,_j \times idf_i
\end{align*}\]</span></p>
<p>Where <span class="math inline">\(w_i,_j\)</span> is the TF-IDF score of term <span class="math inline">\(i\)</span> in document <span class="math inline">\(j\)</span>, <span class="math inline">\(tf_i,_j\)</span> is the term frequency for <span class="math inline">\(i\)</span> in <span class="math inline">\(j\)</span>, and <span class="math inline">\(idf_i\)</span> is the inverse document score.</p>
<p>While it’s good to know the underlying equations here, you won’t be tested on the math specifically. And as it happens, tm has a way to perform the above math for each term in a corpus. We can implement TF-IDF scores when making a document-term matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>dtm_tfidf <span class="ot">&lt;-</span> <span class="fu">DocumentTermMatrix</span>(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>  cleaned_corpus,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">control =</span> <span class="fu">list</span>(<span class="at">weighting =</span> weightTfIdf)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>dtm_tfidf<span class="sc">$</span>dimnames<span class="sc">$</span>Docs <span class="ot">&lt;-</span> manifest<span class="sc">$</span>title</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>To see what difference it makes, let’s plot the top terms in our corpus using their TF-IDF scores:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>tfidf_counts <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dtm_tfidf)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>tfidf_counts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">sort</span>(<span class="fu">colSums</span>(tfidf_counts), <span class="at">decreasing =</span> <span class="cn">TRUE</span>))</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>tfidf_counts <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">newColName =</span> <span class="fu">rownames</span>(tfidf_counts), tfidf_counts)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tfidf_counts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"term"</span>, <span class="st">"tfidf"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> tfidf_counts[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>, ]) <span class="sc">+</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">fct_reorder</span>(term, <span class="sc">-</span>tfidf), <span class="at">y =</span> tfidf) <span class="sc">+</span></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_bar</span>(<span class="at">stat =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>, <span class="at">vjust =</span> <span class="fl">0.5</span>, <span class="at">hjust =</span> <span class="dv">1</span>)</span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Words with the 50-highest TF-IDF scores in 18 Nineteenth-Century Novels"</span>,</span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Word"</span>,</span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"TF-IDF"</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="15_natural-language-processing_files/figure-html/unnamed-chunk-42-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
<p>Lots of names! That makes sense: heavily weighted terms in these novels are going to be terms that are unique to each text. Main characters’ names are used a lot in novels, and the main character names in these novels are all unique.</p>
<p>To see in more concrete way how TF-IDF scores might make a difference in the way we analyze our corpus, we’ll do two last things. First, we’ll look again at term correlations, using the same words from above with <code>findAssocs</code>, but this time we’ll use TF-IDF scores.</p>
<p>Here’s “boat”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="fu">findAssocs</span>(dtm_tfidf, <span class="at">terms =</span> <span class="st">"boat"</span>, <span class="at">corlimit =</span> .<span class="dv">85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$boat
   thumping       shore      bucket      cables         doo       geese 
       0.95        0.93        0.92        0.92        0.92        0.92 
    pickled         sea      rudder     gunwale  scoundrels       boats 
       0.92        0.91        0.91        0.91        0.91        0.90 
       keel      sailed        crew    baffling     biscuit    bowsprit 
       0.90        0.89        0.89        0.89        0.89        0.89 
    hauling     muskets      ripped      splash      anchor         oar 
       0.89        0.89        0.89        0.89        0.88        0.88 
   rattling       sandy        cook      patted     shipped       beach 
       0.88        0.88        0.88        0.88        0.88        0.87 
    pistols      seamen     tobacco         lee    bulwarks      hauled 
       0.87        0.87        0.87        0.87        0.87        0.87 
    inkling      musket  navigation        rags    steering      island 
       0.87        0.87        0.87        0.87        0.87        0.86 
     bottle     tumbled       avast       belay       bilge   broadside 
       0.86        0.86        0.86        0.86        0.86        0.86 
   cruising   cutlasses    diagonal   furtively     headway     jupiter 
       0.86        0.86        0.86        0.86        0.86        0.86 
   mainland      marlin      midday     monthly   mutineers outnumbered 
       0.86        0.86        0.86        0.86        0.86        0.86 
    plumped     riggers    schooner   schooners   seaworthy    swamping 
       0.86        0.86        0.86        0.86        0.86        0.86 
     tide's      tiller     tonnage       towed       yawed        sail 
       0.86        0.86        0.86        0.86        0.86        0.85 
       ship         tap     loading       sails         aft      berths 
       0.85        0.85        0.85        0.85        0.85        0.85 
     pinned 
       0.85 </code></pre>
</div>
</div>
<p>Here’s “writing”:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">findAssocs</span>(dtm_tfidf, <span class="at">terms =</span> <span class="st">"writing"</span>, <span class="at">corlimit =</span> .<span class="dv">85</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$writing
    hindrance      messages      disposal     inquiries      bedrooms 
         0.92          0.91          0.90          0.90          0.89 
     ladyship          copy      lodgings        london    unforeseen 
         0.88          0.87          0.87          0.87          0.87 
     drawings    plantation  explanations   certificate         dears 
         0.86          0.86          0.86          0.86          0.86 
neighbourhood    allowances 
         0.85          0.85 </code></pre>
</div>
</div>
<p>The semantics of these results have changed. For “boats”, we get much more terms related to seafaring. Most probably this is because only a few novels talk about boats so these terms correlate highly with one another. For “writing”, we’ve interestingly lost a lot of the words associated with writing in a strict sense (“copy”, “message”) but we’ve gained instead a list of terms that seem to situate us in <em>where</em> writing takes place in these novels, or what characters write <em>about</em>. So far though this is speculation; we’d have to look into this further to see whether the hypothesis holds.</p>
<p>Finally, we can disaggregate our giant term count graph from above to focus more closely on the uniqueness of individual novels in our corpus. First, we’ll make a data frame from our TF-IDF DTM. We’ll transpose the DTM so the documents are our variables (columns) and the corpus vocabulary terms are our observations (or rows). Don’t forget the <code>t</code>!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>tfidf_df <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dtm_tfidf)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>tfidf_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">t</span>(tfidf_df))</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(tfidf_df) <span class="ot">&lt;-</span> manifest<span class="sc">$</span>title</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="unique-terms-in-a-document" class="level3" data-number="15.7.3">
<h3 data-number="15.7.3" class="anchored" data-anchor-id="unique-terms-in-a-document"><span class="header-section-number">15.7.3</span> Unique Terms in a Document</h3>
<p>With this data frame made, we can order our rows by the highest value for a given column. In other words, we can find out not only the top terms for a novel, but the top most <em>unique</em> terms in that novel.</p>
<p>Here’s <em>Dracula</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>ordering <span class="ot">&lt;-</span> <span class="fu">order</span>(tfidf_df<span class="sc">$</span>Dracula, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tfidf_df[ordering[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>], ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "helsing"      "mina"         "lucy"         "jonathan"     "van"         
 [6] "harker"       "godalming"    "quincey"      "seward"       "professor"   
[11] "morris"       "lucy's"       "harker's"     "diary"        "seward's"    
[16] "arthur"       "renfield"     "westenra"     "whilst"       "undead"      
[21] "tonight"      "whitby"       "dracula"      "varna"        "carfax"      
[26] "journal"      "helsing's"    "count"        "count's"      "hawkins"     
[31] "madam"        "galatz"       "jonathan's"   "mina's"       "pier"        
[36] "wolves"       "tomorrow"     "czarina"      "telegram"     "boxes"       
[41] "today"        "holmwood"     "hypnotic"     "garlic"       "vampire"     
[46] "phonograph"   "transylvania" "cliff"        "piccadilly"   "slovaks"     </code></pre>
</div>
</div>
<p>Note here that some contractions have slipped through. Lemmatizing would take care of this, though we could also go back to the corpus object and add in another step with <code>tm_map</code> and then make another DTM:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>cleaned_corpus <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>  cleaned_corpus, str_remove_all, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">'s"</span>, <span class="at">replacement =</span> <span class="st">" "</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We won’t bother to do this whole process now, but it’s a good example of how iterative the preprocessing workflow is.</p>
<p>Here’s <em>Frankenstein</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>ordering <span class="ot">&lt;-</span> <span class="fu">order</span>(tfidf_df<span class="sc">$</span>Frankenstein, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tfidf_df[ordering[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>], ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "clerval"      "justine"      "elizabeth"    "felix"        "geneva"      
 [6] "frankenstein" "safie"        "cottagers"    "dæmon"        "ingolstadt"  
[11] "kirwin"       "agatha"       "victor"       "ernest"       "mont"        
[16] "krempe"       "lacey"        "waldman"      "agrippa"      "walton"      
[21] "mountains"    "creator"      "cottage"      "sledge"       "hovel"       
[26] "switzerland"  "ice"          "beaufort"     "cornelius"    "william"     
[31] "protectors"   "moritz"       "henry"        "labours"      "chamounix"   
[36] "glacier"      "jura"         "blanc"        "endeavoured"  "lake"        
[41] "leghorn"      "monster"      "rhine"        "magistrate"   "belrive"     
[46] "lavenza"      "salêve"       "saville"      "strasburgh"   "werter"      </code></pre>
</div>
</div>
<p>And here’s <em>Sense and Sensibility</em>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>ordering <span class="ot">&lt;-</span> <span class="fu">order</span>(tfidf_df<span class="sc">$</span>SenseandSensibility, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(tfidf_df[ordering[<span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>], ])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "elinor"       "marianne"     "dashwood"     "jennings"     "willoughby"  
 [6] "lucy"         "brandon"      "barton"       "ferrars"      "colonel"     
[11] "mrs"          "marianne's"   "edward"       "middleton"    "elinor's"    
[16] "norland"      "palmer"       "steele"       "dashwoods"    "jennings's"  
[21] "willoughby's" "edward's"     "delaford"     "steeles"      "cleveland"   
[26] "mama"         "dashwood's"   "lucy's"       "brandon's"    "fanny"       
[31] "allenham"     "middletons"   "devonshire"   "combe"        "ferrars's"   
[36] "sister"       "morton"       "miss"         "margaret"     "park"        
[41] "charlotte"    "exeter"       "magna"        "berkeley"     "harley"      
[46] "john"         "middleton's"  "parsonage"    "beaux"        "behaviour"   </code></pre>
</div>
</div>
<p>Names still rank high, but we can see in these results other words that indeed seem to be particular to each novel. With this data, we now have a sense of what makes each document unique in its relationship with all other documents in a corpus.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../chapters/14_network-analysis.html" class="pagination-link" aria-label="Network Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Network Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../chapters/16_geospatial-data.html" class="pagination-link" aria-label="Geospatial Data">
        <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Geospatial Data</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/ucdavisdatalab/adventures_in_data_science/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li><li><a href="https://github.com/ucdavisdatalab/adventures_in_data_science/blob/main/chapters/15_natural-language-processing.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div></div></footer></body></html>